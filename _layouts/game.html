---
layout: default
---
<div id="story-game-root"></div>

<!-- React and ReactDOM -->
<script src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

<!-- Game Component -->
<script>
const StoryGame = () => {
  // Function to parse story content from markdown
  const parseStoryContent = async (nodeId) => {
    try {
      console.log(`Attempting to load node: ${nodeId}`);
      // Try to fetch the node file using the correct path structure
      const response = await fetch(`/socialstudies/_data/story/nodes/${nodeId}.md`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to fetch node ${nodeId}: ${response.status}`);
          }
          return response.text();
        });
      
      console.log(`Successfully loaded node: ${nodeId}`);
      const lines = response.split('\n');
      
      // Find frontmatter boundaries (---) 
      let frontmatterStart = -1;
      let frontmatterEnd = -1;
      
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].trim() === '---') {
          if (frontmatterStart === -1) {
            frontmatterStart = i;
          } else {
            frontmatterEnd = i;
            break;
          }
        }
      }
      
      if (frontmatterStart === -1 || frontmatterEnd === -1) {
        console.error('Error: Could not find frontmatter in markdown file');
        return null;
      }
      
      // Parse frontmatter
      const frontmatter = {};
      lines.slice(frontmatterStart + 1, frontmatterEnd).forEach(line => {
        if (line.includes(':')) {
          const [key, ...valueParts] = line.split(':');
          const value = valueParts.join(':').trim();
          frontmatter[key.trim()] = value;
        }
      });
      
      // Get main content (everything between frontmatter and [choices] section)
      let mainContentEnd = lines.findIndex(line => line.trim() === '[choices]');
      if (mainContentEnd === -1) mainContentEnd = lines.length;
      
      const mainContent = lines.slice(frontmatterEnd + 1, mainContentEnd).join('\n').trim();
      
      // Parse choices section
      const choices = [];
      let currentChoice = null;
      let inChoices = false;
      let inRewards = false;
      let currentRewardCategory = null;
      
      for (let i = mainContentEnd; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (line === '[choices]') {
          inChoices = true;
          continue;
        }
        
        if (!inChoices) continue;
        
        if (line.startsWith('- text:')) {
          // Start a new choice
          if (currentChoice) {
            choices.push(currentChoice);
          }
          
          currentChoice = {
            text: line.substring('- text:'.length).trim().replace(/^"(.+)"$/, '$1'),
            rewards: {}
          };
          inRewards = false;
        } else if (line.startsWith('  next:')) {
          if (currentChoice) {
            currentChoice.next = line.substring('  next:'.length).trim();
          }
        } else if (line.startsWith('  rewards:')) {
          inRewards = true;
        } else if (inRewards && line.startsWith('    ')) {
          // Inside rewards section
          if (line.endsWith(':')) {
            // This is a category like "skills:"
            currentRewardCategory = line.trim().slice(0, -1);
            if (!currentChoice.rewards[currentRewardCategory]) {
              currentChoice.rewards[currentRewardCategory] = [];
            }
          } else if (line.startsWith('      -') && currentRewardCategory) {
            // This is a reward item
            const rewardItem = line.substring('      -'.length).trim().replace(/^"(.+)"$/, '$1');
            currentChoice.rewards[currentRewardCategory].push(rewardItem);
          }
        }
      }
      
      // Add the last choice if there is one
      if (currentChoice) {
        choices.push(currentChoice);
      }
      
      return {
        nodeId: nodeId,
        title: frontmatter.title || '',
        text: mainContent,
        choices: choices.length > 0 ? choices : null
      };
    } catch (error) {
      console.error(`Error loading story node ${nodeId}:`, error);
      console.error('File path attempted:', `/socialstudies/_data/story/nodes/${nodeId}.md`);
      
      // If there's an error, show a debugging view with helpful information
      return {
        nodeId: nodeId,
        title: 'Error Loading Node',
        text: `Could not load node "${nodeId}". Error details: ${error.message}

Troubleshooting tips:
1. Check if the file exists at /socialstudies/_data/story/nodes/${nodeId}.md
2. Verify that the file has proper frontmatter (--- sections)
3. Check your browser console for more details`,
        choices: [{
          text: 'Go back to start',
          next: 'start',
          rewards: {}
        }]
      };
    }
  };

  const [currentNode, setCurrentNode] = React.useState('start'); // Start with start.md
  const [storyContent, setStoryContent] = React.useState(null);
  const [loading, setLoading] = React.useState(true);
  const [history, setHistory] = React.useState([]);
  const [journal, setJournal] = React.useState({
    skills: [],
    relationships: [],
    knowledge: [],
    items: [],
    character_traits: []
  });

  React.useEffect(() => {
    const loadInitialContent = async () => {
      setLoading(true);
      const content = await parseStoryContent(currentNode);
      if (content) {
        setStoryContent(content);
      }
      setLoading(false);
    };
    
    loadInitialContent();
  }, [currentNode]);

  const handleChoice = async (choice) => {
    // Add current node to history before moving
    setHistory(prev => [...prev, currentNode]);
    
    // Update journal with rewards
    if (choice.rewards) {
      setJournal(prev => {
        const newJournal = { ...prev };
        
        // Process each reward category
        Object.entries(choice.rewards).forEach(([category, items]) => {
          if (Array.isArray(items) && items.length > 0) {
            if (!newJournal[category]) newJournal[category] = [];
            // Add unique items only
            newJournal[category] = [...new Set([...newJournal[category], ...items])];
          }
        });
        
        return newJournal;
      });
    }

    // Update current node - make sure the nodeId is lowercase to match your file naming
    const nextNode = choice.next.toLowerCase();
    setCurrentNode(nextNode);
  };
  
  const goBack = () => {
    if (history.length > 0) {
      // Get the last node from history
      const previousNode = history[history.length - 1];
      
      // Remove the last node from history
      setHistory(prev => prev.slice(0, -1));
      
      // Set current node to previous node
      setCurrentNode(previousNode);
    }
  };

  const resetGame = async () => {
    setCurrentNode('start');
    setHistory([]);
    setJournal({
      skills: [],
      relationships: [],
      knowledge: [],
      items: [],
      character_traits: []
    });
  };

  // Journal Section Component
  const JournalSection = ({ title, items }) => {
    if (!items || items.length === 0) return null;
    return React.createElement('div', { className: 'journal-section' },
      React.createElement('h3', { key: 'title' }, title),
      React.createElement('ul', { key: 'list' }, 
        items.map((item, index) => 
          React.createElement('li', { key: index }, item)
        )
      )
    );
  };

  if (loading) {
    return React.createElement('div', { className: 'loading' }, 'Loading story...');
  }

  if (!storyContent) {
    return React.createElement('div', { className: 'error' }, 'Error loading story content');
  }

  return React.createElement('div', { className: 'game-container' }, [
    // Main story section
    React.createElement('div', { key: 'story-section', className: 'story-section' }, [
      React.createElement('div', { key: 'node-id', className: 'node-id' },
        `Node: ${storyContent.nodeId}`
      ),
      React.createElement('h2', { key: 'title', className: 'game-title' }, 
        storyContent.title
      ),
      React.createElement('div', { key: 'story', className: 'story-text', 
        dangerouslySetInnerHTML: { __html: storyContent.text }
      }),
      storyContent.choices && React.createElement('div', { key: 'choices', className: 'choice-container' }, 
        storyContent.choices.map((choice, index) => 
          React.createElement('button', {
            key: `choice-${index}`,
            onClick: () => handleChoice(choice),
            className: 'choice-button'
          }, choice.text)
        )
      ),
      React.createElement('div', { key: 'game-controls', className: 'game-controls' }, [
        history.length > 0 && React.createElement('button', {
          key: 'back-button',
          onClick: goBack,
          className: 'back-button'
        }, 'Go Back'),
        React.createElement('button', {
          key: 'reset-button',
          onClick: resetGame,
          className: 'reset-button'
        }, 'Start Over')
      ])
    ]),
    
    // Journal section
    React.createElement('div', { key: 'journal', className: 'journal' }, [
      React.createElement('h2', { key: 'journal-title', className: 'journal-title' }, 
        'Your Journal'
      ),
      React.createElement(JournalSection, { 
        key: 'skills',
        title: 'Skills Learned',
        items: journal.skills 
      }),
      React.createElement(JournalSection, { 
        key: 'character_traits',
        title: 'Character Traits',
        items: journal.character_traits 
      }),
      React.createElement(JournalSection, { 
        key: 'knowledge',
        title: 'Knowledge Gained',
        items: journal.knowledge 
      }),
      React.createElement(JournalSection, { 
        key: 'relationships',
        title: 'Relationships',
        items: journal.relationships 
      }),
      React.createElement(JournalSection, { 
        key: 'items',
        title: 'Items Acquired',
        items: journal.items 
      })
    ])
  ]);
};

// Render the game
ReactDOM.render(
  React.createElement(StoryGame),
  document.getElementById('story-game-root')
);
</script>

<style>
.game-container {
  display: flex;
  max-width: 1200px;
  margin: 20px auto;
  gap: 20px;
  padding: 20px;
  min-height: 600px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.story-section {
  flex: 2;
  background: white;
  padding: 30px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  position: relative;
  min-height: 400px;
  border: 1px solid #e2e8f0;
}

.journal {
  flex: 1;
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  max-height: 80vh;
  overflow-y: auto;
  border: 1px solid #e2e8f0;
}

.node-id {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 12px;
  color: #718096;
  background: #f7fafc;
  padding: 3px 8px;
  border-radius: 4px;
  border: 1px solid #e2e8f0;
}

.game-title {
  color: #2d3748;
  font-size: 24px;
  margin-bottom: 20px;
  border-bottom: 2px solid #e2e8f0;
  padding-bottom: 10px;
}

.journal-title {
  color: #2d3748;
  font-size: 20px;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e2e8f0;
}

.story-text {
  font-size: 16px;
  line-height: 1.6;
  margin-bottom: 30px;
  color: #2d3748;
}

.choice-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 60px;
}

.choice-button {
  background: #4a5568;
  color: white;
  padding: 12px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.2s;
  text-align: left;
  line-height: 1.4;
}

.choice-button:hover {
  background: #2d3748;
}

.game-controls {
  position: absolute;
  bottom: 20px;
  left: 20px;
  display: flex;
  gap: 10px;
}

.back-button {
  background: #3182ce;
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
}

.back-button:hover {
  background: #2c5282;
}

.reset-button {
  background: #e53e3e;
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
}

.reset-button:hover {
  background: #c53030;
}

.loading {
  text-align: center;
  padding: 2rem;
  font-size: 1.2rem;
  color: #4a5568;
}

.error {
  text-align: center;
  padding: 2rem;
  color: #e53e3e;
  font-size: 1.2rem;
}

.journal-section {
  margin-bottom: 20px;
}

.journal-section h3 {
  color: #4a5568;
  font-size: 16px;
  margin-bottom: 8px;
  padding-bottom: 4px;
  border-bottom: 1px solid #e2e8f0;
}

.journal-section ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.journal-section li {
  font-size: 14px;
  color: #4a5568;
  padding: 6px 0;
  border-bottom: 1px solid #edf2f7;
}

@media (max-width: 768px) {
  .game-container {
    flex-direction: column;
  }
  
  .journal {
    max-height: none;
  }
  
  .story-section {
    min-height: 300px;
  }

  .choice-container {
    margin-bottom: 80px;
  }

  .choice-button {
    font-size: 14px;
    padding: 10px 16px;
  }
}
</style>
